<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.casaba.mapper.UserMapper">
    <!-- 基础的 User 类结果映射：不包括 complaintList -->
    <resultMap id="user_map_base" type="com.casaba.entity.User">
        <id property="id" column="ID"/>
        <result property="username" column="USERNAME"/>
        <result property="contactNum" column="CONTACT_NUM"/>
        <result property="wcOpenId" column="WC_OPEN_ID"/>
    </resultMap>

    <!-- User 类对象映射，包括 complaintList，不包括 WeChatUser -->
    <resultMap id="user_map_comp" type="com.casaba.entity.User">
        <!-- 因为主表和从表主键名一样，所以需要其中一个起别名。这里的 column 是指查询结果中的列名，所以也要跟着改 -->
        <id property="id" column="UID"/>
        <result property="username" column="USERNAME"/>
        <result property="contactNum" column="CONTACT_NUM"/>
        <result property="wcOpenId" column="WC_OPEN_ID"/>
        <!-- property：在从表中的主表类对象的变量名；column：主表的关联的字段名；select：查询从表数据的方法； -->
        <association property="weChatUser" column="WC_OPEN_ID" javaType="com.casaba.entity.WeChatUser"
                     select="com.casaba.mapper.WeChatUserMapper.selectByOpenId"/>
        <collection property="complaintList" ofType="com.casaba.entity.Complaint" column="USER_ID">
            <id property="id" column="ID"/>
            <result property="details" column="DETAILS"/>
            <result property="sketch" column="SKETCH"/>
            <result property="imgUrl" column="IMG_URL"/>
            <result property="elevatorId" column="ELEVATOR_ID"/>
            <result property="userId" column="USER_ID"/>
        </collection>
    </resultMap>

    <!-- 根据用户名搜索该用户是否已经存在 -->
    <select id="findUserByUsername" resultType="com.casaba.entity.User" parameterType="java.lang.String">
        SELECT * FROM tb_user WHERE USERNAME = #{username}
    </select>

    <!-- 添加一个用户 -->
    <insert id="insertUser" parameterType="com.casaba.entity.User">
        INSERT INTO tb_user VALUES (#{id}, #{username}, #{contactNum}, #{wcOpenId})
    </insert>

    <!--获取最新插入的主键ID（即最大的ID）-->
    <select id="selectMaxId" resultType="java.lang.Long">
        SELECT max(id) FROM tb_user
    </select>

    <!-- 根据用户名和联系方式查询用户及其投诉单 -->
    <select id="selectUserByUserame$ContactNum" resultMap="user_map_comp">
        SELECT u.ID UID, u.USERNAME, u.CONTACT_NUM, c.* FROM tb_user u
        JOIN tb_complaint c ON u.ID = c.USER_ID
        <choose>
            <when test="username != null">
                WHERE u.USERNAME = #{username}
                <if test="contactNum != null">
                    AND u.CONTACT_NUM = #{contactNum}
                </if>
            </when>
            <otherwise>
                WHERE u.CONTACT_NUM = #{contactNum}
            </otherwise>
        </choose>
    </select>

    <!-- 根据openid查询电梯用户 -->
    <select id="selectByWcOpenId" resultMap="user_map_base">
        SELECT * FROM tb_user WHERE WC_OPEN_ID = #{openId}
    </select>

    <!-- 根据用户名，更新电梯用户信息 -->
    <update id="updateUserByName" parameterType="com.casaba.entity.User">
        UPDATE tb_user
        SET CONTACT_NUM = #{contactNum},
            WC_OPEN_ID = #{wcOpenId}
        WHERE USERNAME = #{username}
    </update>
</mapper>